name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install Backend Dependencies
      run: |
        echo "ğŸ“¦ Instalando dependencias del backend..."
        npm install --production
        echo "âœ… Dependencias del backend instaladas"
    
    - name: Install Frontend Dependencies
      run: |
        echo "ğŸ“¦ Instalando dependencias del frontend..."
        cd client
        npm install
        echo "âœ… Dependencias del frontend instaladas"
    
    - name: Build Frontend
      run: |
        echo "ğŸ—ï¸  Construyendo frontend..."
        cd client
        npm run build
        echo "âœ… Frontend construido exitosamente"
        ls -lh dist/assets/ | head -5
      
    - name: Prepare deployment files
      run: |
        echo "ğŸ“¦ Preparando archivos para despliegue..."
        # Create a clean deployment directory
        mkdir -p deploy-temp
        # Copy files excluding unwanted directories
        rsync -av \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='client/node_modules' \
          --exclude='.env*' \
          --exclude='logs' \
          --exclude='*.log' \
          --exclude='deploy-temp' \
          --exclude='client/src' \
          --exclude='tests' \
          . deploy-temp/
        # Create tar.gz for deployment
        cd deploy-temp
        tar -czf ../deployment.tar.gz .
        cd ..
        echo "âœ… Archivos preparados ($(du -h deployment.tar.gz | cut -f1))"

    - name: Copy files to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "deployment.tar.gz"
        target: "/home/nicolic3/balancechile.nicolich.cl/"
        strip_components: 0
        overwrite: true

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "ğŸš€ Iniciando despliegue en VPS..."
          
          # Navegar al directorio del proyecto
          cd /home/nicolic3/balancechile.nicolich.cl/
          echo "ğŸ“ Directorio: $(pwd)"
          echo "ğŸ‘¤ Usuario: $(whoami)"
          
          # Configurar variables de entorno
          export NODE_ENV=production
          echo "ğŸ”§ NODE_ENV: $NODE_ENV"
          
          # Extraer archivo de despliegue
          if [ -f "deployment.tar.gz" ]; then
            echo "ğŸ“¦ Extrayendo archivos..."
            tar -xzf deployment.tar.gz
            rm deployment.tar.gz
            echo "âœ… Archivos extraÃ­dos"
          else
            echo "âŒ Error: deployment.tar.gz no encontrado"
            exit 1
          fi
          
          # Verificar que npm estÃ¡ disponible
          if ! command -v npm >/dev/null 2>&1; then
            echo "âŒ Error: npm no estÃ¡ disponible"
            echo "ğŸ’¡ Instala Node.js en el servidor"
            exit 1
          fi
          
          echo "ğŸ“¦ Node.js: $(node --version)"
          echo "ğŸ“¦ npm: $(npm --version)"
          
          # Instalar dependencias del backend (solo producciÃ³n)
          echo "ğŸ“¦ Instalando dependencias del backend..."
          npm install --production --no-audit --no-fund
          
          # Verificar que cheerio se instalÃ³ (crÃ­tico para BCN)
          if [ -d "node_modules/cheerio" ]; then
            echo "âœ… cheerio instalado correctamente"
          else
            echo "âš ï¸  cheerio no encontrado, instalando..."
            npm install cheerio --production
          fi
          
          # Verificar estructura del build del frontend
          echo "ğŸ” Verificando build del frontend..."
          if [ -d "client/dist" ]; then
            echo "âœ… client/dist/ encontrado"
            if [ -f "client/dist/index.html" ]; then
              echo "âœ… client/dist/index.html encontrado"
            else
              echo "âŒ Error: client/dist/index.html no encontrado"
              exit 1
            fi
            if [ -d "client/dist/assets" ]; then
              echo "âœ… client/dist/assets/ encontrado"
              echo "ğŸ“Š Archivos en assets:"
              ls -lh client/dist/assets/ | head -5
            else
              echo "âŒ Error: client/dist/assets/ no encontrado"
              exit 1
            fi
          else
            echo "âŒ Error: client/dist/ no encontrado"
            echo "ğŸ’¡ El build del frontend debe estar incluido en el deployment"
            exit 1
          fi
          
          # Verificar archivos crÃ­ticos
          echo "ğŸ” Verificando archivos crÃ­ticos..."
          [ -f "app.js" ] && echo "âœ… app.js" || echo "âŒ app.js"
          [ -f "src/server.js" ] && echo "âœ… src/server.js" || echo "âŒ src/server.js"
          [ -f "src/services/bcnService.js" ] && echo "âœ… bcnService.js" || echo "âŒ bcnService.js"
          [ -f "package.json" ] && echo "âœ… package.json" || echo "âŒ package.json"
          
          # Verificar configuraciÃ³n
          if [ -f "config.env" ]; then
            echo "âœ… config.env encontrado"
          else
            echo "âš ï¸  config.env no encontrado (normal si estÃ¡ en .gitignore)"
          fi
          
          # Crear directorio tmp si no existe (para restart)
          mkdir -p tmp
          
          # Reiniciar aplicaciÃ³n (LiteSpeed)
          echo "ğŸ”„ Reiniciando aplicaciÃ³n..."
          touch tmp/restart.txt
          
          echo ""
          echo "âœ… Â¡DESPLIEGUE COMPLETADO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ URL: https://balancechile.nicolich.cl"
          echo "ğŸ“ Directorio: /home/nicolic3/balancechile.nicolich.cl/"
          echo "ğŸ”§ Node.js: $(node --version)"
          echo "ğŸ“¦ Dependencias: Instaladas"
          echo "ğŸ¨ Frontend: Build incluido"
          echo "ğŸ”„ Estado: AplicaciÃ³n reiniciada"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ’¡ Verificar en: https://balancechile.nicolich.cl"
          echo "ğŸ“Š Health check: https://balancechile.nicolich.cl/health"
          echo "ğŸ“š API Docs: https://balancechile.nicolich.cl/api-docs"
